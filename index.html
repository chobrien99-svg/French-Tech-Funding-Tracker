<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Tech Funding Tracker - The French Tech Journal</title>

    <!-- Chrome Performance Optimization Meta Tags -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#0a0f1a">

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://tlwqkglfyjydwsgjrclx.supabase.co" crossorigin>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: rgba(255,255,255,0.04);
            --bg-card-hover: rgba(255,255,255,0.07);
            --border-subtle: rgba(255,255,255,0.08);
            --border-hover: rgba(255,255,255,0.15);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-violet: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, var(--accent-blue), var(--accent-violet));
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, #1e1b4b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Background Effects */
        .bg-effects {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .bg-effects::before {
            content: '';
            position: absolute;
            top: -10%;
            right: -5%;
            width: 40%;
            height: 40%;
            background: radial-gradient(circle, rgba(59,130,246,0.12) 0%, transparent 70%);
            filter: blur(60px);
        }

        .bg-effects::after {
            content: '';
            position: absolute;
            bottom: 10%;
            left: -10%;
            width: 35%;
            height: 35%;
            background: radial-gradient(circle, rgba(139,92,246,0.1) 0%, transparent 70%);
            filter: blur(60px);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(10,15,26,0.9);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 0;
        }

        .header-content {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            width: 44px;
            height: 44px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .brand-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #c7d2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .stat-badge:hover {
            background: rgba(255,255,255,0.08);
        }

        .stat-badge.highlight {
            background: rgba(59,130,246,0.1);
            border-color: rgba(59,130,246,0.3);
            color: #93c5fd;
        }

        .stat-badge .value {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Main Content */
        main {
            padding: 2rem 0 4rem;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title .icon {
            font-size: 1.2rem;
        }

        /* Search & Filters */
        .filters-section {
            margin-bottom: 2rem;
        }

        .search-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .search-wrapper {
            flex: 1;
            min-width: 280px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(59,130,246,0.5);
            background: rgba(255,255,255,0.07);
        }

        .filter-select {
            padding: 0.875rem 2.5rem 0.875rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            min-width: 160px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: rgba(59,130,246,0.5);
        }

        .filter-select option {
            background: #1e293b;
            color: var(--text-primary);
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(59,130,246,0.15);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 8px;
            font-size: 0.75rem;
            color: #93c5fd;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: #93c5fd;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .filter-tag button:hover {
            opacity: 1;
        }

        .results-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 1rem;
        }

        .results-info strong {
            color: var(--text-primary);
        }

        /* Sort Controls */
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sort-controls label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Latest Deals */
        .latest-deals-section {
            margin-bottom: 2.5rem;
        }

        .latest-deals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
            contain: layout style;
        }

        .latest-deal-card {
            background: linear-gradient(135deg, rgba(59,130,246,0.08) 0%, rgba(139,92,246,0.08) 100%);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            contain: layout style paint;
            position: relative;
            overflow: hidden;
        }

        .latest-deal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
        }

        .latest-deal-card:hover {
            border-color: rgba(59,130,246,0.4);
            transform: translateY(-2px);
        }

        .deal-new-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #34d399;
            background: rgba(52,211,153,0.15);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        /* Company Grid */
        .companies-section {
            margin-bottom: 3rem;
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1rem;
            /* Chrome optimization */
            contain: layout style;
            isolation: isolate;
        }

        @media (max-width: 400px) {
            .companies-grid {
                grid-template-columns: 1fr;
            }
        }

        .company-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            /* Chrome optimization */
            contain: layout style paint;
            will-change: transform;
        }

        .company-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .card-title-group {
            flex: 1;
            min-width: 0;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-amount {
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }

        .sector-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
        }

        .sector-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Sector Colors */
        .sector-ai { background: rgba(139,92,246,0.15); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }
        .sector-saas { background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
        .sector-fintech { background: rgba(234,179,8,0.15); color: #fde047; border: 1px solid rgba(234,179,8,0.3); }
        .sector-healthtech { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
        .sector-cleantech { background: rgba(132,204,22,0.15); color: #bef264; border: 1px solid rgba(132,204,22,0.3); }
        .sector-cybersecurity { background: rgba(244,63,94,0.15); color: #fda4af; border: 1px solid rgba(244,63,94,0.3); }
        .sector-ecommerce { background: rgba(245,158,11,0.15); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
        .sector-foodtech { background: rgba(34,197,94,0.15); color: #86efac; border: 1px solid rgba(34,197,94,0.3); }
        .sector-proptech { background: rgba(6,182,212,0.15); color: #67e8f9; border: 1px solid rgba(6,182,212,0.3); }
        .sector-edtech { background: rgba(20,184,166,0.15); color: #5eead4; border: 1px solid rgba(20,184,166,0.3); }
        .sector-mobility { background: rgba(99,102,241,0.15); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); }
        .sector-deeptech { background: rgba(168,85,247,0.15); color: #d8b4fe; border: 1px solid rgba(168,85,247,0.3); }
        .sector-media { background: rgba(236,72,153,0.15); color: #f9a8d4; border: 1px solid rgba(236,72,153,0.3); }
        .sector-biotech { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
        .sector-hrtech { background: rgba(139,92,246,0.15); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }
        .sector-legaltech { background: rgba(100,116,139,0.15); color: #cbd5e1; border: 1px solid rgba(100,116,139,0.3); }
        .sector-default { background: rgba(100,116,139,0.15); color: #cbd5e1; border: 1px solid rgba(100,116,139,0.3); }

        .card-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .card-meta-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .card-meta-item a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .card-meta-item a:hover {
            text-decoration: underline;
        }

        .card-section {
            margin-top: 0.875rem;
            padding-top: 0.875rem;
            border-top: 1px solid var(--border-subtle);
        }

        .card-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .card-founders {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .founder-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .founder-link:hover {
            background: rgba(59,130,246,0.1);
            border-color: rgba(59,130,246,0.3);
            color: #93c5fd;
        }

        .founder-link.has-linkedin {
            color: #93c5fd;
        }

        .founder-link.has-linkedin:hover {
            background: rgba(59,130,246,0.15);
        }

        .card-investors {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .card-news-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            font-style: italic;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .card-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .card-action-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--border-hover);
        }

        .card-action-btn.primary {
            background: rgba(59,130,246,0.15);
            border-color: rgba(59,130,246,0.3);
            color: #93c5fd;
        }

        .card-action-btn.primary:hover {
            background: rgba(59,130,246,0.25);
        }

        .card-meta-item a:hover {
            text-decoration: underline;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 0.6rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .page-btn.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-dots {
            color: var(--text-muted);
            padding: 0 0.5rem;
        }

        /* Analytics Section */
        .analytics-section {
            margin-bottom: 3rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-toggle {
            padding: 0.4rem 0.75rem;
            background: rgba(59,130,246,0.15);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 6px;
            color: #93c5fd;
            font-size: 0.75rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-toggle:hover {
            background: rgba(59,130,246,0.25);
        }

        .chart-container {
            height: 280px;
        }

        /* Top Lists Section */
        .insights-section {
            margin-bottom: 3rem;
        }

        .top-lists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .top-list-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .top-list-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .top-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .top-item-rank {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            min-width: 24px;
        }

        .top-item-name {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .top-item-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-violet);
        }

        /* Map Section */
        .map-section {
            margin-bottom: 3rem;
        }

        .map-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
        }

        #map {
            height: 450px;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .map-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .legend-circle {
            border-radius: 50%;
            background: rgba(59,130,246,0.7);
            border: 2px solid rgba(59,130,246,0.9);
        }

        /* Map Popup Styles */
        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
        }

        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }

        .map-popup {
            padding: 0.5rem;
            min-width: 180px;
        }

        .map-popup-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .map-popup-stats {
            display: grid;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
        }

        .map-popup-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .map-popup-label {
            color: var(--text-muted);
        }

        .map-popup-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .map-popup-button {
            width: 100%;
            padding: 0.5rem;
            background: var(--accent-gradient);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .map-popup-button:hover {
            opacity: 0.9;
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border-subtle);
            padding: 1.5rem 0;
            text-align: center;
            background: rgba(0,0,0,0.2);
        }

        .footer-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .footer-link {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-stats {
                width: 100%;
                justify-content: flex-start;
            }

            .search-row {
                flex-direction: column;
            }

            .filter-select {
                width: 100%;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <div class="bg-effects"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="brand">
                    <div class="brand-icon">üá´üá∑</div>
                    <div class="brand-text">
                        <span class="brand-label">The French Tech Journal</span>
                        <span class="brand-title">French Tech Funding Tracker</span>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="stat-badge highlight">
                        <span class="value" id="stat-companies">-</span>
                        <span>Companies</span>
                    </div>
                    <div class="stat-badge">
                        <span class="value" id="stat-funding">-</span>
                        <span>Total Raised</span>
                    </div>
                    <div class="stat-badge">
                        <span class="value" id="stat-average">-</span>
                        <span>Avg Round</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Search & Filters -->
            <section class="filters-section">
                <div class="search-row">
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="search" placeholder="Search companies, investors, founders...">
                    </div>
                    <select class="filter-select" id="filter-sector">
                        <option value="">All Sectors</option>
                    </select>
                    <select class="filter-select" id="filter-round">
                        <option value="">All Rounds</option>
                    </select>
                    <select class="filter-select" id="filter-city">
                        <option value="">All Cities</option>
                    </select>
                    <select class="filter-select" id="filter-size">
                        <option value="">All Amounts</option>
                        <option value="0-1">Under ‚Ç¨1M</option>
                        <option value="1-5">‚Ç¨1M - ‚Ç¨5M</option>
                        <option value="5-10">‚Ç¨5M - ‚Ç¨10M</option>
                        <option value="10-50">‚Ç¨10M - ‚Ç¨50M</option>
                        <option value="50-999999">Over ‚Ç¨50M</option>
                    </select>
                    <select class="filter-select" id="filter-year">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="active-filters" id="active-filters"></div>
                <div class="results-info" id="results-info"></div>
            </section>

            <!-- Latest Deals -->
            <section class="latest-deals-section">
                <div class="section-header">
                    <h2 class="section-title"><span class="icon">üÜï</span> Latest Deals</h2>
                </div>
                <div class="latest-deals-grid" id="latest-deals-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading latest deals...
                    </div>
                </div>
            </section>

            <!-- Analytics -->
            <section class="analytics-section">
                <div class="section-header">
                    <h2 class="section-title"><span class="icon">üìä</span> Analytics</h2>
                </div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Funding by Sector</h3>
                            <button class="chart-toggle" id="sector-toggle">By Amount ‚Ç¨</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="sectorChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Funding by Round</h3>
                            <button class="chart-toggle" id="rounds-toggle">By Amount ‚Ç¨</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="roundsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Companies Grid -->
            <section class="companies-section">
                <div class="section-header">
                    <h2 class="section-title"><span class="icon">üíº</span> Funding Deals</h2>
                    <div class="sort-controls">
                        <label>Sort:</label>
                        <select class="filter-select" id="sort-by" style="min-width: 180px;">
                            <option value="amount-desc">Highest Amount</option>
                            <option value="amount-asc">Lowest Amount</option>
                            <option value="date-desc">Newest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="name-asc">Name A-Z</option>
                            <option value="name-desc">Name Z-A</option>
                        </select>
                    </div>
                </div>
                <div class="companies-grid" id="companies-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading companies...
                    </div>
                </div>
                <div class="pagination" id="pagination"></div>
            </section>

            <!-- Top Lists -->
            <section class="insights-section">
                <div class="section-header">
                    <h2 class="section-title"><span class="icon">üèÜ</span> Insights</h2>
                </div>
                <div class="top-lists-grid">
                    <div class="top-list-card">
                        <h3 class="top-list-title">üí∞ Largest Rounds</h3>
                        <div id="top-deals"></div>
                    </div>
                    <div class="top-list-card">
                        <h3 class="top-list-title">üèôÔ∏è Top Cities</h3>
                        <div id="top-cities"></div>
                    </div>
                    <div class="top-list-card">
                        <h3 class="top-list-title">ü§ù Most Active Investors</h3>
                        <div id="top-investors"></div>
                    </div>
                </div>
            </section>

            <!-- Map -->
            <section class="map-section">
                <div class="section-header">
                    <h2 class="section-title"><span class="icon">üó∫Ô∏è</span> Geographic Distribution</h2>
                </div>
                <div class="map-card">
                    <div class="chart-header">
                        <span class="chart-title">Funding Across France</span>
                        <button class="chart-toggle" id="map-toggle">By Amount ‚Ç¨</button>
                    </div>
                    <div id="map"></div>
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-circle" style="width: 10px; height: 10px;"></div>
                            <span>&lt; ‚Ç¨100M</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle" style="width: 16px; height: 16px;"></div>
                            <span>‚Ç¨100M - ‚Ç¨500M</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle" style="width: 24px; height: 24px;"></div>
                            <span>&gt; ‚Ç¨500M</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p class="footer-text">
                Data tracked by <a href="https://thefrenchtechjournal.com" class="footer-link" target="_blank">The French Tech Journal</a> ¬∑
                Updated January 2026
            </p>
        </div>
    </footer>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8QEY5FFC59"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8QEY5FFC59');
    </script>

    <script>
        // ===========================================
        // FRENCH TECH FUNDING TRACKER
        // Supabase-connected, Chrome-optimized
        // ===========================================

        // Supabase Configuration
        const SUPABASE_URL = 'https://tlwqkglfyjydwsgjrclx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsd3FrZ2xmeWp5ZHdzZ2pyY2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk5MDMsImV4cCI6MjA4NDg2NTkwM30.C_836n1iosx6u2FfAb-VIN95x0KfibAbg3lvD1LCoaI';

        // State
        let allCompanies = [];
        let filteredCompanies = [];
        let currentPage = 1;
        const itemsPerPage = 24;
        let sectorChart = null;
        let roundsChart = null;
        let map = null;
        let markers = [];
        let sectorChartMode = 'funding';
        let roundsChartMode = 'funding';
        let mapMode = 'funding';

        // Chrome optimization: Debounce/throttle utilities
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // City coordinates for map
        const cityCoordinates = {
            'Paris': [48.8566, 2.3522],
            'Lyon': [45.7640, 4.8357],
            'Marseille': [43.2965, 5.3698],
            'Toulouse': [43.6047, 1.4442],
            'Nice': [43.7102, 7.2620],
            'Nantes': [47.2184, -1.5536],
            'Montpellier': [43.6108, 3.8767],
            'Strasbourg': [48.5734, 7.7521],
            'Bordeaux': [44.8378, -0.5792],
            'Lille': [50.6292, 3.0573],
            'Rennes': [48.1173, -1.6778],
            'Grenoble': [45.1885, 5.7245],
            'Montreuil': [48.8614, 2.4436],
            'Annecy': [45.8992, 6.1294],
            'Aix-en-Provence': [43.5297, 5.4474],
            'Boulogne-Billancourt': [48.8350, 2.2397],
            'Clermont-Ferrand': [45.7772, 3.0870]
        };

        // Sector to CSS class mapping
        function getSectorClass(sectorName) {
            const mapping = {
                'AI & Machine Learning': 'sector-ai',
                'SaaS & Enterprise': 'sector-saas',
                'FinTech': 'sector-fintech',
                'HealthTech': 'sector-healthtech',
                'CleanTech & Energy': 'sector-cleantech',
                'Cybersecurity': 'sector-cybersecurity',
                'E-commerce & Retail': 'sector-ecommerce',
                'FoodTech & AgriTech': 'sector-foodtech',
                'PropTech & Real Estate': 'sector-proptech',
                'EdTech': 'sector-edtech',
                'Mobility & Logistics': 'sector-mobility',
                'DeepTech & Hardware': 'sector-deeptech',
                'Media & Entertainment': 'sector-media',
                'BioTech & Pharma': 'sector-biotech',
                'HRTech': 'sector-hrtech',
                'LegalTech': 'sector-legaltech'
            };
            return mapping[sectorName] || 'sector-default';
        }

        // Format currency
        function formatCurrency(amount) {
            if (!amount) return '‚Ç¨0';
            if (amount >= 1000) return '‚Ç¨' + (amount / 1000).toFixed(1) + 'B';
            if (amount >= 1) return '‚Ç¨' + amount.toFixed(1) + 'M';
            return '‚Ç¨' + (amount * 1000).toFixed(0) + 'K';
        }

        // ===========================================
        // SUPABASE DATA FETCHING
        // ===========================================

        async function fetchFromSupabase(table, query = '') {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const response = await fetch(url, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            if (!response.ok) throw new Error(`Failed to fetch ${table}`);
            return response.json();
        }

        // Fetch ALL rows from a Supabase table using pagination.
        // The PostgREST default row limit (typically 1000) can silently
        // truncate large tables like funding_round_investors, causing
        // newer records (e.g. 2026 deals) to be missing.
        async function fetchAllRows(table) {
            const pageSize = 1000;
            let allRows = [];
            let offset = 0;

            while (true) {
                const data = await fetchFromSupabase(table,
                    `?select=*&order=id&limit=${pageSize}&offset=${offset}`);
                allRows = allRows.concat(data);
                if (data.length < pageSize) break;
                offset += pageSize;
            }

            return allRows;
        }

        async function loadData() {
            try {
                console.log('[Supabase] Loading data...');
                const startTime = performance.now();

                // Fetch all data in parallel with pagination to ensure
                // every row is retrieved (tables like funding_round_investors
                // can exceed the default PostgREST row limit)
                const [companies, fundingRounds, sectors, companySectors, companyPeople, people, investors, fundingInvestors] = await Promise.all([
                    fetchAllRows('companies'),
                    fetchAllRows('funding_rounds'),
                    fetchAllRows('sectors'),
                    fetchAllRows('company_sectors'),
                    fetchAllRows('company_people'),
                    fetchAllRows('people'),
                    fetchAllRows('investors'),
                    fetchAllRows('funding_round_investors')
                ]);

                // Build lookup maps
                const sectorsMap = new Map(sectors.map(s => [s.id, s]));
                const peopleMap = new Map(people.map(p => [p.id, p]));
                const investorsMap = new Map(investors.map(i => [i.id, i]));
                const companiesMap = new Map(companies.map(c => [c.id, c]));

                // Group data by company
                const companySectorsMap = new Map();
                companySectors.forEach(cs => {
                    if (!companySectorsMap.has(cs.company_id)) companySectorsMap.set(cs.company_id, []);
                    const sector = sectorsMap.get(cs.sector_id);
                    if (sector) companySectorsMap.get(cs.company_id).push(sector.name);
                });

                const companyPeopleMap = new Map();
                companyPeople.forEach(cp => {
                    if (!companyPeopleMap.has(cp.company_id)) companyPeopleMap.set(cp.company_id, []);
                    const person = peopleMap.get(cp.person_id);
                    if (person) companyPeopleMap.get(cp.company_id).push(person);
                });

                const fundingInvestorsMap = new Map();
                fundingInvestors.forEach(fi => {
                    if (!fundingInvestorsMap.has(fi.funding_round_id)) fundingInvestorsMap.set(fi.funding_round_id, []);
                    const investor = investorsMap.get(fi.investor_id);
                    if (investor) fundingInvestorsMap.get(fi.funding_round_id).push(investor.name);
                });

                // Build deal objects ‚Äî one entry per funding round
                // This allows companies with multiple rounds (e.g. Pennylane
                // 2025 + 2026) to each appear as separate deal cards.
                allCompanies = fundingRounds.map(round => {
                    const company = companiesMap.get(round.company_id);
                    if (!company) return null;

                    const investorNames = fundingInvestorsMap.get(round.id) || [];
                    const founders = companyPeopleMap.get(company.id) || [];

                    return {
                        id: round.id,
                        companyId: company.id,
                        company: company.name,
                        description: company.description,
                        website: company.website,
                        hq: company.hq_city_name,
                        sectors: companySectorsMap.get(company.id) || [],
                        amount: Number(round.amount_eur) || 0,
                        round: round.round_type || '',
                        month: round.announced_month || '',
                        year: Number(round.announced_year) || 2025,
                        announcedDate: round.announced_date || null,
                        createdAt: round.created_at || company.created_at,
                        investors: investorNames.join(', '),
                        founders: founders.map(f => f.full_name).join(', '),
                        foundersData: founders,
                        news: round.news_url || '',
                        newsDescription: round.notes || ''
                    };
                }).filter(d => d && d.amount > 0); // Only show deals with funding amounts

                filteredCompanies = [...allCompanies];

                console.log('[Supabase] Data loaded:', allCompanies.length, 'companies in', (performance.now() - startTime).toFixed(0), 'ms');

                // Initialize UI
                initializeFilters();
                initializeCharts();
                initializeMap();
                updateLatestDeals();
                applyFilters();

            } catch (error) {
                console.error('[Supabase] Error loading data:', error);
                document.getElementById('companies-grid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Failed to load data</div>
                        <div class="empty-text">Please try refreshing the page</div>
                    </div>
                `;
            }
        }

        // ===========================================
        // FILTERS
        // ===========================================

        function initializeFilters() {
            const allSectors = new Set();
            const allRounds = new Set();
            const allCities = new Set();
            const allYears = new Set();

            allCompanies.forEach(c => {
                c.sectors.forEach(s => allSectors.add(s));
                if (c.round) allRounds.add(c.round);
                if (c.hq) allCities.add(c.hq);
                if (c.year) allYears.add(c.year);
            });

            // Populate sector filter
            const sectorSelect = document.getElementById('filter-sector');
            Array.from(allSectors).sort().forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorSelect.appendChild(option);
            });

            // Populate round filter
            const roundSelect = document.getElementById('filter-round');
            const roundOrder = ['Pre-Seed', 'Seed', 'Series A', 'Series B', 'Series C', 'Growth'];
            roundOrder.filter(r => allRounds.has(r)).forEach(round => {
                const option = document.createElement('option');
                option.value = round;
                option.textContent = round;
                roundSelect.appendChild(option);
            });

            // Populate city filter
            const citySelect = document.getElementById('filter-city');
            Array.from(allCities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            // Populate year filter (descending order - newest first)
            const yearSelect = document.getElementById('filter-year');
            Array.from(allYears).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            // Event listeners with debouncing
            const debouncedFilter = debounce(applyFilters, 300);
            document.getElementById('search').addEventListener('input', debouncedFilter);
            document.getElementById('filter-sector').addEventListener('change', applyFilters);
            document.getElementById('filter-round').addEventListener('change', applyFilters);
            document.getElementById('filter-city').addEventListener('change', applyFilters);
            document.getElementById('filter-size').addEventListener('change', applyFilters);
            document.getElementById('filter-year').addEventListener('change', applyFilters);
            document.getElementById('sort-by').addEventListener('change', () => { currentPage = 1; updateDisplay(); });

            // Chart toggles
            document.getElementById('sector-toggle').addEventListener('click', toggleSectorChart);
            document.getElementById('rounds-toggle').addEventListener('click', toggleRoundsChart);
            document.getElementById('map-toggle').addEventListener('click', toggleMapMode);
        }

        function applyFilters() {
            currentPage = 1;

            const searchTerm = document.getElementById('search').value.toLowerCase();
            const sectorFilter = document.getElementById('filter-sector').value;
            const roundFilter = document.getElementById('filter-round').value;
            const cityFilter = document.getElementById('filter-city').value;
            const sizeFilter = document.getElementById('filter-size').value;
            const yearFilter = document.getElementById('filter-year').value;

            let sizeMin = 0, sizeMax = Infinity;
            if (sizeFilter) {
                const [min, max] = sizeFilter.split('-').map(Number);
                sizeMin = min;
                sizeMax = max;
            }

            filteredCompanies = allCompanies.filter(company => {
                if (searchTerm) {
                    const searchFields = [
                        company.company,
                        company.description,
                        company.hq,
                        company.investors,
                        company.founders,
                        ...company.sectors
                    ].filter(Boolean).join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }

                if (sectorFilter && !company.sectors.includes(sectorFilter)) return false;
                if (roundFilter && company.round !== roundFilter) return false;
                if (cityFilter && company.hq !== cityFilter) return false;
                if (sizeFilter && (company.amount < sizeMin || company.amount > sizeMax)) return false;
                if (yearFilter && company.year !== parseInt(yearFilter)) return false;

                return true;
            });

            updateActiveFilters();
            updateDisplay();
            updateStats();
            updateCharts();
            updateMapMarkers();
        }

        function updateActiveFilters() {
            const container = document.getElementById('active-filters');
            container.innerHTML = '';

            const filters = [
                { id: 'filter-sector', label: 'Sector' },
                { id: 'filter-round', label: 'Round' },
                { id: 'filter-city', label: 'City' },
                { id: 'filter-size', label: 'Size' },
                { id: 'filter-year', label: 'Year' }
            ];

            filters.forEach(filter => {
                const select = document.getElementById(filter.id);
                if (select.value) {
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    tag.innerHTML = `${filter.label}: ${select.options[select.selectedIndex].text} <button onclick="clearFilter('${filter.id}')">√ó</button>`;
                    container.appendChild(tag);
                }
            });

            const searchTerm = document.getElementById('search').value;
            if (searchTerm) {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `Search: "${searchTerm}" <button onclick="clearSearch()">√ó</button>`;
                container.appendChild(tag);
            }
        }

        function clearFilter(filterId) {
            document.getElementById(filterId).value = '';
            applyFilters();
        }

        function clearSearch() {
            document.getElementById('search').value = '';
            applyFilters();
        }

        // ===========================================
        // DISPLAY
        // ===========================================

        function updateStats() {
            const totalFunding = filteredCompanies.reduce((sum, c) => sum + (c.amount || 0), 0);
            const avgFunding = filteredCompanies.length > 0 ? totalFunding / filteredCompanies.length : 0;
            const uniqueCompanies = new Set(filteredCompanies.map(c => c.companyId)).size;

            document.getElementById('stat-companies').textContent = uniqueCompanies;
            document.getElementById('stat-funding').textContent = formatCurrency(totalFunding);
            document.getElementById('stat-average').textContent = formatCurrency(avgFunding);

            document.getElementById('results-info').innerHTML = `Showing <strong>${filteredCompanies.length}</strong> deals from ${uniqueCompanies} companies`;
        }

        function updateLatestDeals() {
            const grid = document.getElementById('latest-deals-grid');

            // Sort by createdAt (most recent first), then take top 6
            const latestDeals = [...allCompanies]
                .sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA;
                })
                .slice(0, 6);

            if (latestDeals.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-title">No deals yet</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = latestDeals.map(deal => {
                // Build sector badges
                const sectorsHTML = deal.sectors.map(s =>
                    `<span class="sector-badge ${getSectorClass(s)}">${s}</span>`
                ).join('');

                // Build founders HTML with LinkedIn links where available
                let foundersHTML = '';
                if (deal.foundersData && deal.foundersData.length > 0) {
                    const allFounders = [];
                    deal.foundersData.forEach(founder => {
                        if (founder.full_name && founder.full_name.includes(';')) {
                            founder.full_name.split(';').forEach(name => {
                                const trimmedName = name.trim();
                                if (trimmedName) {
                                    allFounders.push({ full_name: trimmedName, linkedin_url: null });
                                }
                            });
                        } else {
                            allFounders.push(founder);
                        }
                    });

                    const founderLinks = allFounders.map(founder => {
                        if (founder.linkedin_url) {
                            return `<a href="${founder.linkedin_url}" target="_blank" rel="noopener" class="founder-link has-linkedin" title="View LinkedIn">
                                <span>in</span> ${founder.full_name}
                            </a>`;
                        } else {
                            return `<span class="founder-link">${founder.full_name}</span>`;
                        }
                    }).join('');
                    foundersHTML = `
                        <div class="card-section">
                            <div class="card-section-title">Founders</div>
                            <div class="card-founders">${founderLinks}</div>
                        </div>
                    `;
                }

                // Build investors HTML
                let investorsHTML = '';
                if (deal.investors) {
                    investorsHTML = `
                        <div class="card-section">
                            <div class="card-section-title">Investors</div>
                            <div class="card-investors">${deal.investors}</div>
                        </div>
                    `;
                }

                // Build news description HTML (from notes field when no URL available)
                let newsDescHTML = '';
                if (!deal.news && deal.newsDescription) {
                    newsDescHTML = `
                        <div class="card-section">
                            <div class="card-section-title">News</div>
                            <div class="card-news-desc">${deal.newsDescription}</div>
                        </div>
                    `;
                }

                // Build action buttons
                let actionsHTML = '<div class="card-actions">';
                if (deal.website) {
                    actionsHTML += `<a href="${deal.website}" target="_blank" rel="noopener" class="card-action-btn">üîó Website</a>`;
                }
                if (deal.news) {
                    actionsHTML += `<a href="${deal.news}" target="_blank" rel="noopener" class="card-action-btn primary">üì∞ News Source</a>`;
                }
                actionsHTML += '</div>';

                return `
                    <div class="latest-deal-card">
                        <div class="deal-new-badge">‚óè New</div>
                        <div class="card-header">
                            <div class="card-title-group">
                                <div class="card-title">${deal.company}</div>
                            </div>
                            <div class="card-amount">${formatCurrency(deal.amount)}</div>
                        </div>
                        <div class="sector-badges">${sectorsHTML}</div>
                        ${deal.description ? `<div class="card-description">${deal.description}</div>` : ''}
                        <div class="card-meta">
                            ${deal.hq ? `<div class="card-meta-item">üìç ${deal.hq}</div>` : ''}
                            ${deal.round ? `<div class="card-meta-item">üíº ${deal.round}</div>` : ''}
                            ${deal.month ? `<div class="card-meta-item">üìÖ ${deal.month} ${deal.year}</div>` : ''}
                        </div>
                        ${foundersHTML}
                        ${investorsHTML}
                        ${newsDescHTML}
                        ${(deal.website || deal.news) ? actionsHTML : ''}
                    </div>
                `;
            }).join('');
        }

        function updateDisplay() {
            const sortBy = document.getElementById('sort-by').value;
            const sorted = [...filteredCompanies].sort((a, b) => {
                switch (sortBy) {
                    case 'amount-desc': return (b.amount || 0) - (a.amount || 0);
                    case 'amount-asc': return (a.amount || 0) - (b.amount || 0);
                    case 'date-desc': return (b.year || 0) - (a.year || 0) || (b.amount || 0) - (a.amount || 0);
                    case 'date-asc': return (a.year || 0) - (b.year || 0) || (a.amount || 0) - (b.amount || 0);
                    case 'name-asc': return (a.company || '').localeCompare(b.company || '');
                    case 'name-desc': return (b.company || '').localeCompare(a.company || '');
                    default: return 0;
                }
            });

            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageCompanies = sorted.slice(startIndex, startIndex + itemsPerPage);
            const totalPages = Math.ceil(sorted.length / itemsPerPage);

            const grid = document.getElementById('companies-grid');

            if (pageCompanies.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">No companies found</div>
                        <div class="empty-text">Try adjusting your filters</div>
                    </div>
                `;
            } else {
                grid.innerHTML = pageCompanies.map(company => {
                    const sectorsHTML = company.sectors.map(s =>
                        `<span class="sector-badge ${getSectorClass(s)}">${s}</span>`
                    ).join('');

                    // Build founders HTML with LinkedIn links where available
                    let foundersHTML = '';
                    if (company.foundersData && company.foundersData.length > 0) {
                        // Flatten founders - some may have multiple names separated by semicolons
                        const allFounders = [];
                        company.foundersData.forEach(founder => {
                            // Check if name contains semicolons (multiple founders in one record)
                            if (founder.full_name && founder.full_name.includes(';')) {
                                // Split and create individual entries (no LinkedIn for split names)
                                founder.full_name.split(';').forEach(name => {
                                    const trimmedName = name.trim();
                                    if (trimmedName) {
                                        allFounders.push({ full_name: trimmedName, linkedin_url: null });
                                    }
                                });
                            } else {
                                allFounders.push(founder);
                            }
                        });

                        const founderLinks = allFounders.map(founder => {
                            if (founder.linkedin_url) {
                                return `<a href="${founder.linkedin_url}" target="_blank" rel="noopener" class="founder-link has-linkedin" title="View LinkedIn">
                                    <span>in</span> ${founder.full_name}
                                </a>`;
                            } else {
                                return `<span class="founder-link">${founder.full_name}</span>`;
                            }
                        }).join('');
                        foundersHTML = `
                            <div class="card-section">
                                <div class="card-section-title">Founders</div>
                                <div class="card-founders">${founderLinks}</div>
                            </div>
                        `;
                    }

                    // Build investors HTML
                    let investorsHTML = '';
                    if (company.investors) {
                        investorsHTML = `
                            <div class="card-section">
                                <div class="card-section-title">Investors</div>
                                <div class="card-investors">${company.investors}</div>
                            </div>
                        `;
                    }

                    // Build action buttons
                    let actionsHTML = '<div class="card-actions">';
                    if (company.website) {
                        actionsHTML += `<a href="${company.website}" target="_blank" rel="noopener" class="card-action-btn">üîó Website</a>`;
                    }
                    if (company.news) {
                        actionsHTML += `<a href="${company.news}" target="_blank" rel="noopener" class="card-action-btn primary">üì∞ News Source</a>`;
                    }
                    actionsHTML += '</div>';

                    return `
                        <div class="company-card">
                            <div class="card-header">
                                <div class="card-title-group">
                                    <div class="card-title">${company.company}</div>
                                </div>
                                <div class="card-amount">${formatCurrency(company.amount)}</div>
                            </div>
                            <div class="sector-badges">${sectorsHTML}</div>
                            ${company.description ? `<div class="card-description">${company.description}</div>` : ''}
                            <div class="card-meta">
                                ${company.hq ? `<div class="card-meta-item">üìç ${company.hq}</div>` : ''}
                                ${company.round ? `<div class="card-meta-item">üíº ${company.round}</div>` : ''}
                                ${company.month ? `<div class="card-meta-item">üìÖ ${company.month} ${company.year}</div>` : ''}
                            </div>
                            ${foundersHTML}
                            ${investorsHTML}
                            ${(company.website || company.news) ? actionsHTML : ''}
                        </div>
                    `;
                }).join('');
            }

            renderPagination(totalPages);
            updateTopLists();
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
                if (startPage > 2) html += '<span class="page-dots">...</span>';
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span class="page-dots">...</span>';
                html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;

            container.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredCompanies.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateDisplay();
            document.querySelector('.companies-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ===========================================
        // TOP LISTS
        // ===========================================

        function updateTopLists() {
            // Top Deals
            const topDeals = [...filteredCompanies]
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 8);

            document.getElementById('top-deals').innerHTML = topDeals.map((c, i) => `
                <div class="top-item">
                    <span class="top-item-rank">${i + 1}</span>
                    <span class="top-item-name">${c.company}</span>
                    <span class="top-item-value">${formatCurrency(c.amount)}</span>
                </div>
            `).join('');

            // Top Cities
            const cityData = {};
            filteredCompanies.forEach(c => {
                if (c.hq) {
                    if (!cityData[c.hq]) cityData[c.hq] = { count: 0, funding: 0 };
                    cityData[c.hq].count++;
                    cityData[c.hq].funding += c.amount || 0;
                }
            });

            const topCities = Object.entries(cityData)
                .sort((a, b) => b[1].funding - a[1].funding)
                .slice(0, 8);

            document.getElementById('top-cities').innerHTML = topCities.map(([city, data], i) => `
                <div class="top-item" onclick="filterByCity('${city}')">
                    <span class="top-item-rank">${i + 1}</span>
                    <span class="top-item-name">${city}</span>
                    <span class="top-item-value">${formatCurrency(data.funding)}</span>
                </div>
            `).join('');

            // Top Investors
            const investorCounts = {};
            filteredCompanies.forEach(c => {
                if (c.investors) {
                    c.investors.split(',').map(i => i.trim()).filter(Boolean).forEach(inv => {
                        investorCounts[inv] = (investorCounts[inv] || 0) + 1;
                    });
                }
            });

            const topInvestors = Object.entries(investorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            document.getElementById('top-investors').innerHTML = topInvestors.map(([investor, count], i) => `
                <div class="top-item">
                    <span class="top-item-rank">${i + 1}</span>
                    <span class="top-item-name">${investor}</span>
                    <span class="top-item-value">${count} deals</span>
                </div>
            `).join('');
        }

        function filterByCity(city) {
            document.getElementById('filter-city').value = city;
            applyFilters();
            document.querySelector('.companies-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ===========================================
        // CHARTS
        // ===========================================

        const chartColors = [
            '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
            '#14b8a6', '#a855f7'
        ];

        function initializeCharts() {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.08)';

            const sectorCtx = document.getElementById('sectorChart').getContext('2d');
            sectorChart = new Chart(sectorCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: chartColors, borderWidth: 0 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const sectorName = sectorChart.data.labels[index];
                            // Set the sector filter and apply
                            const sectorSelect = document.getElementById('filter-sector');
                            sectorSelect.value = sectorName;
                            applyFilters();
                        }
                    }
                }
            });

            const roundsCtx = document.getElementById('roundsChart').getContext('2d');
            roundsChart = new Chart(roundsCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: '#3b82f6', borderRadius: 6 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            updateCharts();
        }

        const updateCharts = throttle(function() {
            if (!sectorChart || !roundsChart) return;

            // Sector data
            const sectorData = {};
            filteredCompanies.forEach(c => {
                c.sectors.forEach(s => {
                    if (!sectorData[s]) sectorData[s] = { count: 0, funding: 0 };
                    sectorData[s].count++;
                    sectorData[s].funding += c.amount || 0;
                });
            });

            const sortedSectors = Object.entries(sectorData)
                .sort((a, b) => sectorChartMode === 'funding' ? b[1].funding - a[1].funding : b[1].count - a[1].count)
                .slice(0, 10);

            sectorChart.data.labels = sortedSectors.map(([s]) => s);
            sectorChart.data.datasets[0].data = sortedSectors.map(([, d]) => sectorChartMode === 'funding' ? d.funding : d.count);
            sectorChart.update('none');

            // Rounds data
            const roundData = {};
            const roundOrder = ['Pre-Seed', 'Seed', 'Series A', 'Series B', 'Series C', 'Growth'];
            filteredCompanies.forEach(c => {
                if (c.round && roundOrder.includes(c.round)) {
                    if (!roundData[c.round]) roundData[c.round] = { count: 0, funding: 0 };
                    roundData[c.round].count++;
                    roundData[c.round].funding += c.amount || 0;
                }
            });

            const sortedRounds = roundOrder.filter(r => roundData[r]).map(r => [r, roundData[r]]);

            roundsChart.data.labels = sortedRounds.map(([r]) => r);
            roundsChart.data.datasets[0].data = sortedRounds.map(([, d]) => roundsChartMode === 'funding' ? d.funding : d.count);
            roundsChart.update('none');
        }, 150);

        function toggleSectorChart() {
            sectorChartMode = sectorChartMode === 'funding' ? 'count' : 'funding';
            document.getElementById('sector-toggle').textContent = sectorChartMode === 'funding' ? 'By Amount ‚Ç¨' : 'By Count #';
            updateCharts();
        }

        function toggleRoundsChart() {
            roundsChartMode = roundsChartMode === 'funding' ? 'count' : 'funding';
            document.getElementById('rounds-toggle').textContent = roundsChartMode === 'funding' ? 'By Amount ‚Ç¨' : 'By Count #';
            updateCharts();
        }

        // ===========================================
        // MAP
        // ===========================================

        function initializeMap() {
            map = L.map('map', { scrollWheelZoom: false }).setView([46.603354, 1.888334], 6);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 19
            }).addTo(map);

            updateMapMarkers();
        }

        const updateMapMarkers = throttle(function() {
            if (!map) return;

            markers.forEach(m => { m.unbindPopup(); map.removeLayer(m); });
            markers = [];

            const cityData = {};
            filteredCompanies.forEach(c => {
                if (c.hq && cityCoordinates[c.hq]) {
                    if (!cityData[c.hq]) cityData[c.hq] = { count: 0, funding: 0 };
                    cityData[c.hq].count++;
                    cityData[c.hq].funding += c.amount || 0;
                }
            });

            Object.entries(cityData).forEach(([city, data]) => {
                const coords = cityCoordinates[city];
                if (!coords) return;

                const value = mapMode === 'funding' ? data.funding : data.count;
                let radius = value < 100 ? 8 : value < 500 ? 14 : 22;
                if (mapMode === 'count') radius = data.count < 10 ? 8 : data.count < 30 ? 14 : 22;

                const marker = L.circleMarker(coords, {
                    radius,
                    fillColor: '#3b82f6',
                    color: '#1e3a8a',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                });

                marker.bindPopup(`
                    <div class="map-popup">
                        <div class="map-popup-title">${city}</div>
                        <div class="map-popup-stats">
                            <div class="map-popup-stat">
                                <span class="map-popup-label">Companies</span>
                                <span class="map-popup-value">${data.count}</span>
                            </div>
                            <div class="map-popup-stat">
                                <span class="map-popup-label">Total Funding</span>
                                <span class="map-popup-value">${formatCurrency(data.funding)}</span>
                            </div>
                        </div>
                        <button class="map-popup-button" onclick="filterByCity('${city}')">View Companies</button>
                    </div>
                `);

                marker.addTo(map);
                markers.push(marker);
            });
        }, 100);

        function toggleMapMode() {
            mapMode = mapMode === 'funding' ? 'count' : 'funding';
            document.getElementById('map-toggle').textContent = mapMode === 'funding' ? 'By Amount ‚Ç¨' : 'By Count #';
            updateMapMarkers();
        }

        // ===========================================
        // INITIALIZE
        // ===========================================

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
